<!-- delvee/lobby.html (FULL FILE REPLACEMENT) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lobby — Delvee</title>
  <meta name="theme-color" content="#0F1114" id="meta-theme-color" />

  <link rel="stylesheet" href="./styles.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCECKG-00tijJrt5qvRy3L27ZzE7bocNrU",
      authDomain: "setfeed-fcd7a.firebaseapp.com",
      projectId: "setfeed-fcd7a",
      storageBucket: "setfeed-fcd7a.firebasestorage.app",
      messagingSenderId: "553573263069",
      appId: "1:553573263069:web:e5c9884101ca38eaee1d34"
    };

    if (!firebase.apps || firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const functions = firebase.app().functions("europe-west2");
    const db = firebase.firestore();
  </script>

  <!-- Theme -->
  <script>
    (function(){
      const THEME_KEY = "sf_theme_mode";
      const root = document.documentElement;

      function applyTheme(){
        let stored = "system";
        try { stored = localStorage.getItem(THEME_KEY) || "system"; } catch (_) {}

        if (stored === "light" || stored === "dark") root.setAttribute("data-theme", stored);
        else root.removeAttribute("data-theme");

        const effective =
          root.getAttribute("data-theme") ||
          (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        const meta = document.getElementById("meta-theme-color");
        if (meta) meta.content = (effective === "dark") ? "#0F1114" : "#FFFBFE";
      }

      applyTheme();
      window.addEventListener("storage", (e) => { if (e && e.key === THEME_KEY) applyTheme(); });
    })();
  </script>
</head>

<body class="dv-bg">
  <header class="dv-top">
    <div class="dv-top-inner">
      <div class="dv-brand">
        <a class="dv-mark" href="./index.html" aria-label="Delvee home"></a>
        <div>
          <div class="dv-title">Delvee</div>
          <div class="dv-sub" id="sessionLabel">Lobby</div>
        </div>
      </div>

      <div class="dv-top-actions">
        <button class="dv-chip" id="btn-copy" type="button">Copy code</button>
        <button class="dv-chip" id="btn-home" type="button">Home</button>
        <button class="dv-chip" id="btn-leave" type="button">Leave</button>
      </div>
    </div>
  </header>

  <main class="dv-wrap dv-wrap-wide">
    <section class="dv-card dv-card-wide">

      <div class="dv-status dv-status-tight" id="status">
        <span class="dv-dot" id="statusDot"></span>
        <div>
          <div class="dv-status-title" id="statusTitle">Connecting…</div>
          <div class="dv-status-line" id="statusLine">Preparing realtime lobby.</div>
        </div>
        <div class="dv-right" id="countdown"></div>
      </div>

      <!-- Immersive layout: participants | feed | chat -->
      <div class="dv-layout-immersive">
        <aside class="dv-immersive-side">
          <div class="dv-panel">
            <div class="dv-panel-head">
              <h2 class="dv-h2">Participants</h2>
              <div class="dv-pill" id="statePill">—</div>
            </div>
            <div class="dv-list" id="participants"></div>

            <div style="height: 12px;"></div>

            <div class="dv-row">
              <button class="dv-btn" id="btn-ready" type="button">Ready</button>

              <div class="dv-host hidden" id="hostControls">
                <select id="duration" class="dv-select" aria-label="Duration">
                  <option value="4">4 min</option>
                  <option value="5">5 min</option>
                </select>
                <button class="dv-btn dv-btn-primary" id="btn-start" type="button">Start</button>
              </div>
            </div>

            <div class="dv-help" id="hint">Anonymous live preview during RUNNING. Chat opens during cooldown.</div>
          </div>
        </aside>

        <section class="dv-immersive-main">
          <div class="dv-panel">
            <div class="dv-panel-head">
              <h2 class="dv-h2">Live preview</h2>
              <div class="dv-muted" id="feedMeta">—</div>
            </div>

            <div class="dv-feed dv-feed-immersive" id="feed"></div>

            <div class="dv-slab" id="composer" style="margin-top: 12px;">
              <div class="dv-slab-head">
                <div class="dv-slab-title">Pulse</div>
                <div class="dv-soft" id="composerState">—</div>
              </div>

              <div class="dv-row" style="align-items: stretch;">
                <textarea id="pulseText" maxlength="100" placeholder="Write a pulse (≤100 chars)"></textarea>
                <button class="dv-btn dv-btn-primary" id="btn-pulse" type="button">Pulse</button>
              </div>

              <div class="dv-row">
                <input class="dv-file" id="pulseImage" type="file" accept="image/*" />
                <button class="dv-btn dv-btn-primary" id="btn-image" type="button">Pulse image</button>
              </div>

              <div class="dv-help dv-help-tight" id="composerHelp">Pulses are throttled. Keep it flowing.</div>
            </div>
          </div>
        </section>

        <aside class="dv-immersive-side">
          <div class="dv-panel">
            <div class="dv-panel-head">
              <h2 class="dv-h2">Chat</h2>
              <div class="dv-muted" id="chatMeta">Opens in cooldown</div>
            </div>

            <div class="dv-chat" id="chat"></div>

            <div class="dv-chatbox">
              <input id="chatText" maxlength="300" placeholder="Ask who sent what…" />
              <button class="dv-btn" id="btn-chat" type="button">Send</button>
            </div>

            <div class="dv-help dv-help-tight" id="chatHint">Chat is rate limited. Keep it clean.</div>
          </div>
        </aside>
      </div>

    </section>
  </main>

  <style>
    /* Lobby-only layout helpers */
    .dv-layout-immersive{
      display:grid;
      grid-template-columns: 320px 1fr 320px;
      gap: var(--dv-s-4);
      margin-top: var(--dv-s-4);
      align-items: start;
    }
    .dv-feed-immersive{
      min-height: 520px;
      max-height: 62vh;
    }
    .dv-immersive-side{ min-width: 0; }
    .dv-immersive-main{ min-width: 0; }
    @media (max-width: 1100px){
      .dv-layout-immersive{
        grid-template-columns: 1fr;
      }
      .dv-feed-immersive{
        max-height: 58vh;
      }
    }
    @media (max-width: 720px){
      #pulseText{ min-height: 88px; }
    }
  </style>

  <script>
    // -------------------------
    // Utilities
    // -------------------------
    const qs = new URLSearchParams(window.location.search);
    const sessionId = (qs.get("session") || "").trim().toUpperCase();

    const ALIAS_KEY = "dv_alias";
    const myAlias = (() => {
      try { return (localStorage.getItem(ALIAS_KEY) || "").trim(); } catch (_) { return ""; }
    })();

    function setStatus(kind, title, line) {
      const dot = document.getElementById("statusDot");
      const t = document.getElementById("statusTitle");
      const l = document.getElementById("statusLine");
      dot.className = "dv-dot";
      if (kind === "good") dot.classList.add("good");
      if (kind === "warn") dot.classList.add("warn");
      t.textContent = title;
      l.textContent = line;
    }

    function fmtMs(ms) {
      const s = Math.max(0, Math.floor(ms / 1000));
      const mm = String(Math.floor(s / 60)).padStart(2, "0");
      const ss = String(s % 60).padStart(2, "0");
      return `${mm}:${ss}`;
    }

    function randomId(prefix) {
      return `${prefix}_${Date.now()}_${Math.random().toString(16).slice(2)}`;
    }

    function escapeHtml(s) {
      return String(s || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;");
    }

    function setHidden(el, hidden) {
      if (!el) return;
      el.classList.toggle("hidden", !!hidden);
    }

    if (!sessionId) {
      setStatus("warn", "Missing session", "Open a lobby from Delvee home.");
      setTimeout(() => window.location.href = "./index.html", 800);
    }

    document.getElementById("sessionLabel").textContent = sessionId ? `Session ${sessionId}` : "Lobby";

    // -------------------------
    // Elements
    // -------------------------
    const btnCopy = document.getElementById("btn-copy");
    const btnLeave = document.getElementById("btn-leave");
    const btnHome = document.getElementById("btn-home");

    const participantsEl = document.getElementById("participants");
    const statePill = document.getElementById("statePill");
    const hint = document.getElementById("hint");

    const btnReady = document.getElementById("btn-ready");
    const hostControls = document.getElementById("hostControls");
    const btnStart = document.getElementById("btn-start");
    const durationSel = document.getElementById("duration");

    const countdownEl = document.getElementById("countdown");

    const feed = document.getElementById("feed");
    const feedMeta = document.getElementById("feedMeta");

    const composer = document.getElementById("composer");
    const composerState = document.getElementById("composerState");
    const pulseText = document.getElementById("pulseText");
    const btnPulse = document.getElementById("btn-pulse");
    const pulseImage = document.getElementById("pulseImage");
    const btnImage = document.getElementById("btn-image");
    const composerHelp = document.getElementById("composerHelp");

    const chat = document.getElementById("chat");
    const chatText = document.getElementById("chatText");
    const btnChat = document.getElementById("btn-chat");
    const chatMeta = document.getElementById("chatMeta");

    // -------------------------
    // Firestore refs
    // -------------------------
    const sref = db.collection("delvee_sessions").doc(sessionId);
    const pref = sref.collection("participants");
    const pulsesRef = sref.collection("pulses");
    const chatRef = sref.collection("chat");

    // -------------------------
    // Local state
    // -------------------------
    let unsub = [];
    let session = null;
    let me = null;
    let isHost = false;
    let state = "—";

    let pendingTextPulse = null;
    let pendingImagePulse = null;

    const downloadUrlCache = new Map();

    // -------------------------
    // Actions
    // -------------------------
    btnCopy.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(sessionId);
        setStatus("good", "Copied", "Session code copied.");
      } catch (_) {
        setStatus("warn", "Copy failed", "Copy manually from the header.");
      }
    });

    btnHome.addEventListener("click", () => {
      window.location.href = `./index.html?session=${encodeURIComponent(sessionId)}`;
    });

    btnLeave.addEventListener("click", async () => {
      try {
        const leave = functions.httpsCallable("delveeLeaveSession");
        await leave({ sessionId });
      } catch (_) {}
      window.location.href = "./index.html";
    });

    btnReady.addEventListener("click", async () => {
      if (!auth.currentUser) return;

      const next = !(me && me.ready);
      try {
        btnReady.disabled = true;
        const call = functions.httpsCallable("delveeSetReady");
        await call({ sessionId, ready: next });
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t update", (e && e.message) ? e.message : "Try again.");
      } finally {
        btnReady.disabled = false;
      }
    });

    btnStart.addEventListener("click", async () => {
      if (!isHost) return;
      try {
        btnStart.disabled = true;
        const call = functions.httpsCallable("delveeStartSession");
        await call({ sessionId, durationMinutes: Number(durationSel.value) });
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t start", (e && e.message) ? e.message : "Try again.");
      } finally {
        btnStart.disabled = false;
      }
    });

    btnPulse.addEventListener("click", async () => {
      const text = pulseText.value.trim();
      if (!text) return;

      if (state !== "RUNNING") {
        setStatus("warn", "Not running", "Wait for the host to start.");
        return;
      }

      try {
        btnPulse.disabled = true;
        composerHelp.textContent = "Sending pulse…";

        if (!pendingTextPulse) pendingTextPulse = randomId("p");
        const call = functions.httpsCallable("delveePulseText");
        await call({ sessionId, clientPulseId: pendingTextPulse, text });

        pendingTextPulse = null;
        pulseText.value = "";
        composerHelp.textContent = "Sent.";
      } catch (e) {
        console.error(e);
        composerHelp.textContent = "Couldn’t pulse. Try again.";
        setStatus("warn", "Pulse failed", (e && e.message) ? e.message : "Try again.");
      } finally {
        btnPulse.disabled = false;
      }
    });

    btnImage.addEventListener("click", async () => {
      const file = pulseImage.files && pulseImage.files[0];
      if (!file) return;

      if (state !== "RUNNING") {
        setStatus("warn", "Not running", "Wait for the host to start.");
        return;
      }

      if (!file.type.startsWith("image/")) {
        setStatus("warn", "Not an image", "Choose an image file.");
        return;
      }

      try {
        btnImage.disabled = true;
        composerHelp.textContent = "Uploading image…";

        if (!pendingImagePulse) pendingImagePulse = randomId("img");

        const attachmentId = randomId("a");
        const create = functions.httpsCallable("delveeCreateImageUpload");
        const res = await create({
          sessionId,
          attachmentId,
          sizeBytes: file.size,
          contentType: file.type
        });

        const { uploadUrl, storagePath } = res.data || {};
        if (!uploadUrl || !storagePath) throw new Error("Missing uploadUrl/storagePath");

        const bytes = await file.arrayBuffer();
        await fetch(uploadUrl, {
          method: "PUT",
          headers: { "Content-Type": "application/octet-stream" },
          body: bytes
        });

        const commit = functions.httpsCallable("delveePulseImageCommit");
        await commit({
          sessionId,
          clientPulseId: pendingImagePulse,
          attachment: { storagePath, contentType: file.type, sizeBytes: file.size }
        });

        pendingImagePulse = null;
        pulseImage.value = "";
        composerHelp.textContent = "Image sent.";
      } catch (e) {
        console.error(e);
        composerHelp.textContent = "Couldn’t pulse image. Try again.";
        setStatus("warn", "Image failed", (e && e.message) ? e.message : "Try again.");
      } finally {
        btnImage.disabled = false;
      }
    });

    btnChat.addEventListener("click", async () => {
      const text = chatText.value.trim();
      if (!text) return;

      if (state !== "COOLDOWN" && state !== "DONE") {
        setStatus("warn", "Chat closed", "Chat opens during cooldown.");
        return;
      }

      try {
        btnChat.disabled = true;
        const call = functions.httpsCallable("delveeChatSend");
        await call({ sessionId, text });
        chatText.value = "";
      } catch (e) {
        console.error(e);
        setStatus("warn", "Chat failed", (e && e.message) ? e.message : "Try again.");
      } finally {
        btnChat.disabled = false;
      }
    });

    // -------------------------
    // Realtime rendering
    // -------------------------
    function renderState(nextState) {
      state = nextState || "—";
      statePill.textContent = state;

      if (state === "LOBBY") {
        hint.textContent = "Ready up. Host starts when everyone is ready.";
        composerState.textContent = "Locked";
      } else if (state === "RUNNING") {
        hint.textContent = "Pulse window open. Feed is anonymous.";
        composerState.textContent = "Open";
      } else if (state === "COOLDOWN") {
        hint.textContent = "Cooldown. Chat is open. No new pulses.";
        composerState.textContent = "Closed";
      } else if (state === "DONE") {
        hint.textContent = "Done. Summary should be ready.";
        composerState.textContent = "Closed";
      } else if (state === "CANCELLED") {
        hint.textContent = "This lobby expired before it started.";
        composerState.textContent = "Closed";
      } else {
        hint.textContent = "—";
        composerState.textContent = "—";
      }

      setHidden(composer, state !== "RUNNING");

      const chatOpen = (state === "COOLDOWN" || state === "DONE");
      chatText.disabled = !chatOpen;
      btnChat.disabled = !chatOpen;
      chatMeta.textContent = chatOpen ? "Open" : "Opens in cooldown";
    }

   
