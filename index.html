<!-- delvee/index.html (FULL FILE REPLACEMENT) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Delvee</title>
  <meta name="description" content="Delvee — timed pulse sessions. Anonymous preview. Memory capsule." />
  <meta name="theme-color" content="#0F1114" id="meta-theme-color" />

  <link rel="stylesheet" href="./styles.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCECKG-00tijJrt5qvRy3L27ZzE7bocNrU",
      authDomain: "setfeed-fcd7a.firebaseapp.com",
      projectId: "setfeed-fcd7a",
      storageBucket: "setfeed-fcd7a.firebasestorage.app",
      messagingSenderId: "553573263069",
      appId: "1:553573263069:web:e5c9884101ca38eaee1d34"
    };

    const SITE_ORIGIN = "https://delvee.app";

    if (!firebase.apps || firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const functions = firebase.app().functions("europe-west2");
  </script>

  <!-- Theme (shared key with Setfeed so your toggle carries over) -->
  <script>
    (function(){
      const THEME_KEY = "sf_theme_mode";
      const root = document.documentElement;

      function readStored(){
        try { return localStorage.getItem(THEME_KEY) || "system"; } catch (_) { return "system"; }
      }

      function applyTheme(){
        const stored = readStored();

        if (stored === "light" || stored === "dark") root.setAttribute("data-theme", stored);
        else root.removeAttribute("data-theme");

        const effective =
          root.getAttribute("data-theme") ||
          (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        const meta = document.getElementById("meta-theme-color");
        if (meta) meta.content = (effective === "dark") ? "#0F1114" : "#FFFBFE";
      }

      function setToggleLabel(){
        const btn = document.getElementById("themeToggle");
        if (!btn) return;
        const stored = readStored();
        const effective =
          (stored === "light" || stored === "dark") ? stored :
          (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

        btn.textContent = effective === "dark" ? "Light" : "Dark";
        btn.setAttribute("aria-label", effective === "dark" ? "Switch to light theme" : "Switch to dark theme");
      }

      function wireToggle(){
        const btn = document.getElementById("themeToggle");
        if (!btn) return;

        btn.addEventListener("click", () => {
          const stored = readStored();
          const effective =
            (stored === "light" || stored === "dark") ? stored :
            (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");

          const next = (effective === "dark") ? "light" : "dark";
          try { localStorage.setItem(THEME_KEY, next); } catch (_) {}
          applyTheme();
          setToggleLabel();
        });

        if (window.matchMedia) {
          const mq = window.matchMedia("(prefers-color-scheme: dark)");
          try {
            mq.addEventListener("change", () => { applyTheme(); setToggleLabel(); });
          } catch (_) {}
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => {
          applyTheme();
          setToggleLabel();
          wireToggle();
        }, { once: true });
      } else {
        applyTheme();
        setToggleLabel();
        wireToggle();
      }

      window.addEventListener("storage", (e) => {
        if (e && e.key === THEME_KEY) { applyTheme(); setToggleLabel(); }
      });
    })();
  </script>

  <style>
    .hidden{ display:none !important; }

    /* ✅ Better spacing + centered two-card layout when authed */
    .dv-grid.dv-grid-3{
      gap: 16px !important;
      align-items: stretch;
    }
    body.dv-authed .dv-grid.dv-grid-3{
      grid-template-columns: repeat(2, minmax(0, 420px)) !important;
      justify-content: center !important;
    }
    body.dv-authed #signInPanel{
      display: none !important;
    }

    /* Small polish */
    .dv-panel{ min-height: 100%; }
    .dv-actions{ gap: 10px; }
    .dv-field input[readonly]{
      cursor: default;
      opacity: 0.98;
    }

    /* Join-code header row */
    .dv-inline-row{
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .dv-mini{
      font-size: 12px;
      color: rgba(233,238,246,0.70);
      line-height: 1.35;
    }
    .dv-chiplike{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      color: rgba(233,238,246,0.88);
      font-size: 12.5px;
      white-space: nowrap;
    }
  </style>
</head>

<body class="dv-bg">
  <header class="dv-top">
    <div class="dv-top-inner">
      <div class="dv-brand">
        <div class="dv-mark" aria-hidden="true"></div>
        <div>
          <div class="dv-title">Delvee</div>
          <div class="dv-sub">pulsed messaging</div>
        </div>
      </div>
      <div class="dv-top-actions">
        <button class="dv-theme-toggle" id="themeToggle" type="button">Theme</button>
        <button class="dv-chip" id="btn-resume" type="button" disabled>Resume lobby</button>
        <!-- Hide when not signed in -->
        <button class="dv-btn dv-btn-quiet hidden" id="btn-signout" type="button">Sign out</button>
      </div>
    </div>
  </header>

  <main class="dv-wrap dv-wrap-wide">
    <section class="dv-hero">
      <div class="dv-hero-left">
        <h1 class="dv-h1">Timed collaborative pulses.</h1>
        <p class="dv-lead">
          Anonymous live preview. Throttled submissions. A short window, then reveal.
        </p>

        <div class="dv-status" id="status">
          <span class="dv-dot" id="statusDot"></span>
          <div>
            <div class="dv-status-title" id="statusTitle">Not signed in</div>
            <div class="dv-status-line" id="statusLine">Sign in to create or join a lobby.</div>
          </div>
        </div>

        <div class="dv-grid dv-grid-3">
          <!-- Identity -->
          <div class="dv-panel dv-panel-strong">
            <div class="dv-panel-head">
              <h2 class="dv-h2">Identity</h2>
              <div class="dv-muted" id="identityMeta">locked per lobby</div>
            </div>

            <div class="dv-field">
              <label for="alias">Alias</label>
              <input id="alias" type="text" maxlength="18" placeholder="e.g. Sky" />
              <div class="dv-help">Short. memorable. no emojis.</div>
            </div>

            <div class="dv-divider"></div>

            <div class="dv-inline-row">
              <div>
                <label for="sessionId" style="display:block;">Join code</label>
                <div class="dv-mini" id="codeHint">Sign in, then enter an alias to generate a code.</div>
              </div>
              <span class="dv-chiplike hidden" id="codePill">Code ready</span>
            </div>

            <div class="dv-field" style="margin-top:10px;">
              <input id="sessionId" type="text" placeholder="DV-ABCD-EFGH" readonly />
              <div class="dv-help" id="sessionHelp">This is your lobby code to share.</div>
            </div>

            <div class="dv-actions">
              <button class="dv-btn dv-btn-primary" id="btn-open" type="button" disabled>Open lobby</button>
              <button class="dv-btn" id="btn-copy" type="button" disabled>Copy code</button>
            </div>

            <div class="dv-help dv-help-tight" id="createHelp">
              Once the code is created, you can open the lobby and invite others.
            </div>
          </div>

          <!-- Sign in -->
          <div class="dv-panel" id="signInPanel">
            <div class="dv-panel-head">
              <h2 class="dv-h2">Sign in</h2>
              <div class="dv-muted">same Firebase as Setfeed</div>
            </div>

            <div class="dv-field">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
            </div>

            <div class="dv-actions">
              <button class="dv-btn" id="btn-email" type="button">Send sign-in link</button>
              <button class="dv-btn dv-btn-primary" id="btn-google" type="button">Google</button>
            </div>

            <div class="dv-divider"></div>

            <div class="dv-help">
              Sign-in is required on the web today. Live preview remains anonymous.
            </div>
          </div>

          <!-- Session rules -->
          <div class="dv-panel dv-panel-soft">
            <div class="dv-panel-head">
              <h2 class="dv-h2">Session rules</h2>
              <div class="dv-muted">short window</div>
            </div>

            <div class="dv-kv">
              <div>Preview</div><div>Anonymous during RUNNING</div>
              <div>Timer</div><div>4–5 minutes</div>
              <div>Cooldown</div><div>5 minutes + chat</div>
              <div>Throttle</div><div>min interval + rolling window</div>
              <div>Summary</div><div>unlocks after cooldown</div>
            </div>

            <div class="dv-divider"></div>

            <div class="dv-help">
              This is a memory capsule. Not a feed. Not a chat app.
            </div>
          </div>
        </div>

        <footer class="dv-footer">
          <a class="dv-link" href="https://setfeed.app" rel="noreferrer">Setfeed</a>
          <span class="dv-sep">·</span>
          <span class="dv-muted">Delvee runs as a separate site.</span>
        </footer>
      </div>
    </section>
  </main>

  <script>
    // -------------------------
    // Status helper
    // -------------------------
    const statusDot = document.getElementById("statusDot");
    const statusTitle = document.getElementById("statusTitle");
    const statusLine = document.getElementById("statusLine");

    function setStatus(kind, title, line) {
      statusDot.className = "dv-dot";
      if (kind === "good") statusDot.classList.add("good");
      if (kind === "warn") statusDot.classList.add("warn");
      statusTitle.textContent = title;
      statusLine.textContent = line;
    }

    // -------------------------
    // Elements
    // -------------------------
    const email = document.getElementById("email");
    const alias = document.getElementById("alias");
    const sessionId = document.getElementById("sessionId");

    const btnEmail = document.getElementById("btn-email");
    const btnGoogle = document.getElementById("btn-google");
    const btnSignout = document.getElementById("btn-signout");
    const btnResume = document.getElementById("btn-resume");

    const btnOpen = document.getElementById("btn-open");
    const btnCopy = document.getElementById("btn-copy");

    const codeHint = document.getElementById("codeHint");
    const codePill = document.getElementById("codePill");
    const identityMeta = document.getElementById("identityMeta");

    // -------------------------
    // Local persistence
    // -------------------------
    const EMAIL_FOR_SIGNIN_KEY = "dv_email_for_signin";
    const ALIAS_KEY = "dv_alias";
    const LAST_SESSION_KEY = "dv_last_session";

    // ✅ remember the generated join code for this browser (so we don't create a new one on refresh)
    const GENERATED_SESSION_KEY = "dv_generated_session_id";

    try {
      const saved = localStorage.getItem(ALIAS_KEY);
      if (saved) alias.value = saved;
    } catch (_) {}

    function getLastSession() {
      try { return (localStorage.getItem(LAST_SESSION_KEY) || "").trim().toUpperCase(); } catch (_) { return ""; }
    }
    function setLastSession(sid) {
      try { localStorage.setItem(LAST_SESSION_KEY, String(sid || "").trim().toUpperCase()); } catch (_) {}
    }

    function getGeneratedSession() {
      try { return (localStorage.getItem(GENERATED_SESSION_KEY) || "").trim().toUpperCase(); } catch (_) { return ""; }
    }
    function setGeneratedSession(sid) {
      try { localStorage.setItem(GENERATED_SESSION_KEY, String(sid || "").trim().toUpperCase()); } catch (_) {}
    }

    // -------------------------
    // Navigation
    // -------------------------
    function goLobby(sid) {
      const s = String(sid || "").trim().toUpperCase();
      if (!s) return;
      setLastSession(s);
      window.location.href = `./lobby.html?session=${encodeURIComponent(s)}`;
    }

    btnResume.addEventListener("click", () => {
      const last = getLastSession();
      if (last) goLobby(last);
    });

    btnOpen.addEventListener("click", () => {
      const sid = (sessionId.value || "").trim().toUpperCase();
      if (sid) goLobby(sid);
    });

    btnCopy.addEventListener("click", async () => {
      const sid = (sessionId.value || "").trim().toUpperCase();
      if (!sid) return;
      try {
        await navigator.clipboard.writeText(sid);
        setStatus("good", "Copied", "Join code copied.");
      } catch (_) {
        setStatus("warn", "Copy failed", "Copy manually from the join code field.");
      }
    });

    // -------------------------
    // UI refresh
    // -------------------------
    let creating = false;

    function setAuthedLayout(authed) {
      document.body.classList.toggle("dv-authed", !!authed);
      btnSignout.classList.toggle("hidden", !authed);
    }

    function setCodeReadyUI(ready) {
      codePill.classList.toggle("hidden", !ready);
      btnOpen.disabled = !ready;
      btnCopy.disabled = !ready;
      sessionId.readOnly = true;
      if (ready) {
        codeHint.textContent = "Share this code to invite others.";
        identityMeta.textContent = "locked for this session";
      } else {
        codeHint.textContent = "Sign in, then enter an alias to generate a code.";
        identityMeta.textContent = "locked per lobby";
      }
    }

    function refreshEnabled() {
      const authed = !!auth.currentUser;
      setAuthedLayout(authed);

      const hasAlias = alias.value.trim().length > 0;

      const last = getLastSession();
      btnResume.disabled = !(authed && last);

      // code readiness
      const sid = (sessionId.value || "").trim().toUpperCase();
      setCodeReadyUI(authed && !!sid);

      // status copy
      if (!authed) {
        setStatus("warn", "Not signed in", "Sign in to generate a join code.");
      }
    }

    // -------------------------
    // Auto-create join code
    // -------------------------
    async function maybeCreateJoinCode() {
      const authed = !!auth.currentUser;
      const a = alias.value.trim();
      if (!authed) return;
      if (!a) {
        // no alias yet: clear generated UI (but keep stored id if it exists)
        const existing = getGeneratedSession();
        if (existing) {
          sessionId.value = existing;
          setCodeReadyUI(true);
        } else {
          sessionId.value = "";
          setCodeReadyUI(false);
        }
        return;
      }

      // if we already have one stored, use it
      const existing = getGeneratedSession();
      if (existing) {
        sessionId.value = existing;
        setCodeReadyUI(true);
        return;
      }

      if (creating) return;
      creating = true;

      try {
        setStatus("good", "Creating code…", "Generating a join code for your alias.");
        codeHint.textContent = "Generating…";
        btnOpen.disabled = true;
        btnCopy.disabled = true;

        const create = functions.httpsCallable("delveeCreateSession");
        const res = await create({ alias: a });
        const sid = (res?.data?.sessionId || "").trim().toUpperCase();
        if (!sid) throw new Error("Missing sessionId");

        setGeneratedSession(sid);
        setLastSession(sid);
        sessionId.value = sid;

        setCodeReadyUI(true);
        setStatus("good", "Code ready", "Open the lobby when you’re ready.");
      } catch (e) {
        console.error(e);
        sessionId.value = "";
        setCodeReadyUI(false);
        setStatus("warn", "Couldn’t create code", (e && e.message) ? e.message : "Try again.");
      } finally {
        creating = false;
      }
    }

    // Persist alias
    alias.addEventListener("input", () => {
      try { localStorage.setItem(ALIAS_KEY, alias.value.trim()); } catch (_) {}
      // if user changes alias before code exists, we’ll generate once alias is present
      maybeCreateJoinCode().catch(() => {});
      refreshEnabled();
    });

    // -------------------------
    // Auth
    // -------------------------
    auth.onAuthStateChanged((user) => {
      setAuthedLayout(!!user);

      if (user) {
        setStatus("good", "Signed in", user.email || "Ready");
        // ✅ hide the whole sign-in section automatically via CSS (dv-authed)
        // ✅ create join code once alias is entered (or restore stored code)
        const existing = getGeneratedSession();
        if (existing) {
          sessionId.value = existing;
          setCodeReadyUI(true);
        } else {
          sessionId.value = "";
          setCodeReadyUI(false);
        }
        maybeCreateJoinCode().catch(() => {});
      } else {
        // On sign-out: reset code UI (but keep stored alias)
        sessionId.value = "";
        try { localStorage.removeItem(GENERATED_SESSION_KEY); } catch (_) {}
        setCodeReadyUI(false);
        setStatus("warn", "Not signed in", "Sign in to generate a join code.");
      }

      refreshEnabled();
    });

    btnGoogle.addEventListener("click", async () => {
      try {
        setStatus("good", "Signing in…", "Opening Google sign-in…");
        const provider = new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({ prompt: "select_account" });
        await auth.signInWithPopup(provider);
        setStatus("good", "Signed in", "Enter an alias to generate a join code.");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t sign in", "Google sign-in failed. Check pop-up blocking and try again.");
      }
    });

    btnEmail.addEventListener("click", async () => {
      const em = email.value.trim();
      if (!em) {
        setStatus("warn", "Email needed", "Enter your email to request a sign-in link.");
        return;
      }

      try {
        setStatus("good", "Sending link…", "Check your inbox for the sign-in link.");
        const actionCodeSettings = {
          url: `${SITE_ORIGIN}/index.html#finishSignIn`,
          handleCodeInApp: true
        };

        await auth.sendSignInLinkToEmail(em, actionCodeSettings);
        try { localStorage.setItem(EMAIL_FOR_SIGNIN_KEY, em); } catch (_) {}
        setStatus("good", "Link sent", "Open the link on this device to finish signing in.");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Couldn’t send link", "Email-link sign-in failed. Verify Auth is enabled.");
      }
    });

    (async function finishEmailLinkIfPresent(){
      try {
        const href = window.location.href;
        if (!auth.isSignInWithEmailLink(href)) return;

        let em = "";
        try { em = localStorage.getItem(EMAIL_FOR_SIGNIN_KEY) || ""; } catch (_) {}
        if (!em) em = window.prompt("Confirm your email to finish sign-in:") || "";

        if (!em) {
          setStatus("warn", "Sign-in not finished", "Email is required to finish sign-in.");
          return;
        }

        setStatus("good", "Signing in…", "Finishing email-link sign-in…");
        await auth.signInWithEmailLink(em, href);

        try { localStorage.removeItem(EMAIL_FOR_SIGNIN_KEY); } catch (_) {}
        history.replaceState(null, "", "./index.html");
      } catch (e) {
        console.error(e);
        setStatus("warn", "Sign-in failed", "Couldn’t finish email-link sign-in. Try sending a new link.");
      }
    })();

    btnSignout.addEventListener("click", async () => {
      try {
        await auth.signOut();
        setStatus("warn", "Signed out", "Sign in again to generate a join code.");
      } catch (e) {
        console.error(e);
      }
    });

    // -------------------------
    // Init
    // -------------------------
    // On load, if there’s a stored generated code, show it (authed will enable)
    const existing = getGeneratedSession();
    if (existing) sessionId.value = existing;

    refreshEnabled();
  </script>
</body>
</html>
